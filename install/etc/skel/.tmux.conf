# Increase history limit for more scrollback
set -g history-limit 102400

# Start window numbering at 1
set -g base-index 1

# Start pane numbering at 1
setw -g pane-base-index 1
set-window-option -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Address vim mode switching delay (http://superuser.com/a/252616/65504
set -s escape-time 0

# Focus events enabled for terminals that support them
set -g focus-events on

# Increase tmux display time to 2s
set -g display-time 2000

# Key bindings for common operations
# Reload configuration with prefix+R
bind R source-file ~/.tmux.conf \; display " -| ~/.tmux.conf reloaded ..."

# Toggle mouse mode with prefix+m
bind m set -g mouse \; display " -| Mouse mode #{?mouse,ON,OFF} ..."

# Left status bar with mode indicators (PREFIX and RESIZE)
set -g status-left-length 50
set -g status-left-style 'bg=black fg=white'
set -g status-left "[#S]#{?client_prefix,#[bg=pink fg=black] PREFIX #[default],}#{?#{==:#{client_key_table},RESIZE},#[bg=orange fg=black] RESIZE #[default],}#{?synchronize-panes,#[bg=red fg=white] SYNC #[default],}"

# How often the status line is redrawn
set -g status-interval 2

# Right status bar config
set -g status-right-style 'bg=black fg=white'
set -g status-right-length 82
set -g status-right '#{?window_zoomed_flag,[Z],}#(ip -br addr show | grep -v "^lo" | grep "UP" | grep -v "NO-CARRIER" | awk "{print \$1\":\"\$3}" | grep -v ":$" | head -n1 | xargs -I {} echo "{} ◎ ")#(iw dev | grep Interface | awk "{print \$2}" | xargs -I {} sh -c "IFACE=\$1; OUTPUT=\"\"; BSSID=\$(iw dev \$IFACE link | grep \"Connected to\" | awk \"{print \\\$3}\" | tr -d \":\"); if [ -n \"\$BSSID\" ]; then OUTPUT=\"\$BSSID\"; RSSI=\$(iw dev \$IFACE link | grep signal | awk \"{print \\\$2}\"); CHAN_INFO=\$(iw dev \$IFACE info | grep channel); CHANNEL=\$(echo \"\$CHAN_INFO\" | awk \"{print \\\$2}\"); FREQ=\$(echo \"\$CHAN_INFO\" | grep -oP \"\\\(\\\K[0-9]+(?= MHz\\\))\"); WIDTH=\$(echo \"\$CHAN_INFO\" | grep -oP \"width: \\\K[0-9]+\"); WIFI_INFO=\"\"; if [ -n \"\$RSSI\" ]; then WIFI_INFO=\"\$RSSI\"; fi; if [ -n \"\$FREQ\" ] && [ -n \"\$CHANNEL\" ] && [ -n \"\$WIDTH\" ]; then if [ \"\$FREQ\" -lt 2500 ]; then BAND=\"2\"; elif [ \"\$FREQ\" -lt 5950 ]; then BAND=\"5\"; else BAND=\"6\"; fi; if [ -n \"\$WIFI_INFO\" ]; then WIFI_INFO=\"\$WIFI_INFO|\${BAND}G:\$CHANNEL@\$WIDTH\"; else WIFI_INFO=\"\${BAND}G:\$CHANNEL@\$WIDTH\"; fi; fi; if [ -n \"\$WIFI_INFO\" ]; then OUTPUT=\"\$OUTPUT ◎ \$WIFI_INFO\"; fi; if [ -n \"\$OUTPUT\" ]; then echo \"\$OUTPUT ◎ \"; fi; fi" _ {})#({ top -bn2 -d 0.1 | grep "Cpu(s)" | tail -1 | awk "{printf \"C:%.0f%%|\", 100-\$8}"; free | awk "NR==2{printf \"R:%.0f%%\", \$3*100/\$2}"; }) ◎ %H:%M '

# Colors and terminal settings
set -g default-terminal "tmux-256color"
set -as terminal-features ",xterm-256color:RGB"
# Enable title capability for tmux-256color terminals
set -as terminal-features ",tmux*:title"
# Enable modern terminal features (italics, undercurl, strikethrough)
set -as terminal-features ",*:usstyle"
set -g status-style fg=white,bg=colour234
set -g message-style fg=yellow,bold,bg=black

# Special configuration for root user (red background)
if-shell '[ $(id -u) -eq 0 ]' \
  'set -g status-bg colour88; set -g status-left "#[bg=colour88,fg=colour231,bold] ROOT #[fg=colour231,bg=colour88][#S]#{?client_prefix, PREFIX,}#{?#{==:#{client_key_table},RESIZE}, #[bg=pink fg=black] RESIZE MODE #[default],} "'

# Window status styling
setw -g window-status-style fg=colour244,bg=colour234
setw -g window-status-current-style fg=white,bold,bg=colour27

# Window activity monitoring
setw -g monitor-activity on
set -g visual-activity on

# Enable mouse mode
set -g mouse on
set -g repeat-time 500

# Mouse wheel scrolling enters copy mode automatically
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e'"

# Display pane numbers for longer when using prefix+q
set -g display-panes-time 2000

#-----------------------------------------
# TERMINAL TITLE CONFIGURATION
#-----------------------------------------
# NOTE: For terminal titles to update properly in Konsole (and other terminal
# emulators), BOTH tmux and the shell must cooperate:
#
# 1. tmux's set-titles feature (below) enables title pass-through to the
#    terminal emulator outside of tmux
#
# 2. The shell (bash) must send title updates via PROMPT_COMMAND. Since
#    $TERM is "tmux-256color" inside tmux, /etc/bashrc doesn't automatically
#    set PROMPT_COMMAND (it only matches xterm* and screen* patterns).
#
# 3. KONSOLE USERS: Ensure "Show window title on the titlebar" is CHECKED
#    in Settings → Edit Current Profile → General → Title
#    Without this setting enabled, Konsole will not display the window title
#    that tmux sends, even if everything else is configured correctly.
#
# REQUIRED: Add the following to ~/.bashrc for dynamic title updates:
#   if [[ "$TERM" =~ ^tmux ]]; then
#       PROMPT_COMMAND+=('printf "\033]0;%s@%s:%s\007" "${USER}" "${HOSTNAME%%.*}" "${PWD/#$HOME/\~}"')
#   fi

# Enable terminal title updates
set -g set-titles on
set -g set-titles-string "#S:#W - #T"

# Allow programs running in tmux to change window names
# This is required for PROMPT_COMMAND to update the window title
setw -g allow-rename on

# Synchronize panes (type same commands in all panes) with prefix+S
bind S setw synchronize-panes \; display " -| Synchronize-panes #{?pane_synchronized,ON,OFF} ..."

# Pane border styling
set -g pane-border-style fg=colour237
set -g pane-active-border-style fg=orange
# Display pane numbers in borders (change to 'bottom' or 'off' if preferred)
set -g pane-border-format " #{pane_index} "
set -g pane-border-status top

# Show red background in current window when synchronize-panes is on

setw -g window-status-format ' #I/#W#F'
setw -g window-status-current-format ' #I:#W#F'
# setw -g window-status-current-format '#{?pane_synchronized,#[bg=pink fg=black],} #I:#W#F #{?pane_synchronized,#[default],}'

# Session management
bind-key C-s choose-tree -Zs

#-----------------------------------------
# PANE NAVIGATION AND RESIZING
#-----------------------------------------

# RESIZE MODE: Enter with prefix+r
bind r switch-client -T RESIZE

# Define resize mode bindings with vim-style keys
# Stay in RESIZE mode until Escape is pressed
bind -T RESIZE h resize-pane -L 5 \; switch-client -T RESIZE
bind -T RESIZE j resize-pane -D 5 \; switch-client -T RESIZE
bind -T RESIZE k resize-pane -U 5 \; switch-client -T RESIZE
bind -T RESIZE l resize-pane -R 5 \; switch-client -T RESIZE
bind -T RESIZE Escape switch-client -T root

# Vim-style pane navigation (unbind default last-window from 'l' first)
unbind l
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Keep traditional arrow keys for pane navigation as well
bind Left select-pane -L
bind Down select-pane -D
bind Up select-pane -U
bind Right select-pane -R

# Move last-window functionality (originally on 'l') to semicolon
bind \; last-window

# Open new pane in working directory of current pane
unbind '"'
bind '"' split-window -v -c '#{pane_current_path}'  # Split panes vertically
bind - split-window -v -c '#{pane_current_path}'  # Split panes vertically

unbind %
bind % split-window -h -c '#{pane_current_path}'  # Split panes horizontal
bind | split-window -h -c '#{pane_current_path}'  # Split panes horizontal

# Open new windows in current directory
bind c new-window -c '#{pane_current_path}'

#-----------------------------------------
# VI COPY MODE
#-----------------------------------------
# TUTORIAL:
#   Enter copy mode: prefix+[ or scroll up with mouse
#   Navigate: h/j/k/l (vim keys), w/b (word), 0/$ (line), gg/G (top/bottom)
#   Search: / (forward) or ? (backward), then n/N for next/prev match
#   Select: v (visual) or C-v (rectangle), move to extend selection
#   Copy: y (yanks to clipboard and exits copy mode)
#   Paste: prefix+p (from tmux buffer) or middle-click (if xclip available)
#   Exit: q or Escape
#
# RECTANGLE SELECT (C-v):
#   - Selects a vertical column of text (same width across all lines)
#   - Perfect for copying columns from tables, logs, or aligned data
#   - Movement works the same (h/j/k/l, w/b, 0/$) to define the rectangle
#   - Each row becomes a new line when pasted

# Enable vi mode in copy mode
setw -g mode-keys vi

# Vi-style copy keybindings with clipboard integration
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Copy to system clipboard (requires xclip for X11/Openbox environments)
# Gracefully falls back to tmux buffer only if xclip not available
if-shell 'command -v xclip' \
    "bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -selection clipboard'; \
     bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'xclip -selection clipboard'" \
    "bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel; \
     bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel"

# Paste from tmux buffer
bind p paste-buffer

# Search highlighting in copy mode
set -g mode-style bg=yellow,fg=black

#-----------------------------------------
# PANE MANAGEMENT
#-----------------------------------------

# Mark pane for join operations
bind Space select-pane -m

# Join marked pane to current window
bind @ join-pane

# Clear pane mark
bind M-m select-pane -M

# Rotate panes around
bind -r o rotate-window

#-----------------------------------------
# PANE LAYOUTS (Built-in)
#-----------------------------------------
# NOTE: prefix+Space is bound to mark panes (see PANE MANAGEMENT section above)
# prefix+Alt+1 - Even-horizontal (side-by-side)
# prefix+Alt+2 - Even-vertical (stacked)
# prefix+Alt+3 - Main-horizontal (main on top)
# prefix+Alt+4 - Main-vertical (main on left)
# prefix+Alt+5 - Tiled (grid)
# prefix+z     - Zoom/unzoom current pane
